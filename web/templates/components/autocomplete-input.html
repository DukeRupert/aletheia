{{/*
  Autocomplete Input Component - Searchable dropdown for safety codes

  Usage:
    {{template "autocomplete-input" (dict
      "Name" "safety_code"
      "ID" "safety-code-input"
      "Label" "Safety Code"
      "Placeholder" "Search OSHA codes..."
      "Required" true
      "Value" "OSHA 1926.501"
      "Options" safetyCodes
      "RecentCodes" recentCodes
      "HelpText" "Type to search by code number or description"
    )}}

  Parameters:
    - Name: Input name attribute (required)
    - ID: Input ID attribute (required)
    - Label: Label text (optional)
    - Placeholder: Placeholder text (default: "Search...")
    - Required: Boolean for required validation (default: false)
    - Value: Pre-filled value (optional)
    - Options: Array of safety code objects with Code and Description (required)
    - RecentCodes: Array of recently used codes to show first (optional)
    - HelpText: Help text below input (optional)
    - Error: Error message to display (optional)

  Option object structure:
    {
      "Code": "OSHA 1926.501",
      "Description": "Fall Protection",
      "Category": "Fall Hazards"
    }
*/}}

{{define "autocomplete-input"}}
{{$id := .ID}}
{{$name := .Name}}
{{$required := .Required}}
{{$placeholder := or .Placeholder "Search..."}}

<div class="relative" x-data="autocomplete_{{$id}}">
  {{/* Label */}}
  {{if .Label}}
  <label for="{{$id}}"
         class="block text-sm/6 font-medium text-zinc-950 dark:text-white mb-2">
    {{.Label}}
    {{if $required}}<span class="text-red-600 dark:text-red-400">*</span>{{end}}
  </label>
  {{end}}

  {{/* Help text */}}
  {{if .HelpText}}
  <p class="text-sm text-zinc-500 dark:text-zinc-400 mb-2">
    {{.HelpText}}
  </p>
  {{end}}

  {{/* Hidden input that holds the actual selected value */}}
  <input type="hidden"
         id="{{$id}}"
         name="{{$name}}"
         x-model="selectedValue"
         {{if $required}}required{{end}}>

  {{/* Visible search input */}}
  <div class="relative">
    <input type="text"
           id="{{$id}}-search"
           x-model="query"
           @focus="open = true"
           @input="filterOptions()"
           @keydown.escape="open = false"
           @keydown.arrow-down.prevent="highlightNext()"
           @keydown.arrow-up.prevent="highlightPrevious()"
           @keydown.enter.prevent="selectHighlighted()"
           placeholder="{{$placeholder}}"
           autocomplete="off"
           class="block w-full rounded-lg border-zinc-950/10 px-[calc(theme(spacing.3)-1px)]
                  py-[calc(theme(spacing.2)-1px)] text-base/6 text-zinc-950
                  placeholder:text-zinc-500
                  focus:outline focus:outline-2 focus:-outline-offset-1 focus:outline-blue-500
                  dark:border-white/10 dark:bg-zinc-900 dark:text-white
                  dark:placeholder:text-zinc-400 dark:focus:outline-blue-400
                  {{if .Error}}border-red-500 dark:border-red-400{{end}}">

    {{/* Search icon */}}
    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
      <svg class="h-5 w-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
    </div>
  </div>

  {{/* Error message */}}
  {{if .Error}}
  <p class="mt-2 text-sm text-red-600 dark:text-red-400" role="alert">
    {{.Error}}
  </p>
  {{end}}

  {{/* Dropdown results */}}
  <div x-show="open && filteredOptions.length > 0"
       x-cloak
       @click.away="open = false"
       class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg bg-white
              shadow-lg ring-1 ring-zinc-950/10
              dark:bg-zinc-900 dark:ring-white/10">

    {{/* Recent codes section (if provided and no search query) */}}
    <template x-if="query.length === 0 && recentCodes.length > 0">
      <div>
        <div class="px-3 py-2 text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wide border-b border-zinc-200 dark:border-zinc-800">
          Recently Used
        </div>
        <template x-for="(option, index) in recentCodes" :key="option.Code">
          <button type="button"
                  @click="selectOption(option)"
                  class="w-full text-left px-3 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800
                         transition-colors cursor-pointer"
                  :class="{ 'bg-blue-50 dark:bg-blue-900/20': highlightedIndex === -1 - index }">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-zinc-900 dark:text-zinc-100"
                   x-text="option.Code"></p>
                <p class="text-xs text-zinc-600 dark:text-zinc-400 truncate"
                   x-text="option.Description"></p>
              </div>
              <svg class="w-4 h-4 text-zinc-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </button>
        </template>
        <div class="border-t border-zinc-200 dark:border-zinc-800"></div>
      </div>
    </template>

    {{/* All options / Search results */}}
    <template x-for="(option, index) in filteredOptions" :key="option.Code">
      <button type="button"
              @click="selectOption(option)"
              @mouseenter="highlightedIndex = index"
              class="w-full text-left px-3 py-2 hover:bg-zinc-100 dark:hover:bg-zinc-800
                     transition-colors cursor-pointer"
              :class="{ 'bg-blue-50 dark:bg-blue-900/20': highlightedIndex === index }">
        <div class="flex items-start gap-2">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-zinc-900 dark:text-zinc-100"
               x-text="option.Code"></p>
            <p class="text-xs text-zinc-600 dark:text-zinc-400"
               x-text="option.Description"></p>
            <p class="text-xs text-zinc-500 dark:text-zinc-500 mt-0.5"
               x-show="option.Category"
               x-text="option.Category"></p>
          </div>
        </div>
      </button>
    </template>

    {{/* No results message */}}
    <template x-if="query.length > 0 && filteredOptions.length === 0">
      <div class="px-3 py-6 text-center text-sm text-zinc-500 dark:text-zinc-400">
        <svg class="mx-auto h-8 w-8 mb-2 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>No codes found for "<span x-text="query"></span>"</p>
        <p class="text-xs mt-1">Try searching by code number or description</p>
      </div>
    </template>
  </div>
</div>

{{/* Alpine.js component logic */}}
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('autocomplete_{{$id}}', () => ({
    query: '{{.Value}}',
    selectedValue: '{{.Value}}',
    open: false,
    highlightedIndex: 0,

    // All available options
    allOptions: {{if .Options}}{{.Options | toJSON}}{{else}}[]{{end}},

    // Recently used codes
    recentCodes: {{if .RecentCodes}}{{.RecentCodes | toJSON}}{{else}}[]{{end}},

    // Filtered options based on search
    filteredOptions: [],

    init() {
      // Initialize with all options
      this.filteredOptions = this.allOptions.slice(0, 50); // Limit initial display

      // If there's a pre-filled value, set the query
      if (this.selectedValue) {
        const selected = this.allOptions.find(opt => opt.Code === this.selectedValue);
        if (selected) {
          this.query = selected.Code + ' - ' + selected.Description;
        }
      }
    },

    filterOptions() {
      const searchTerm = this.query.toLowerCase().trim();

      if (searchTerm.length === 0) {
        // Show limited options when no search
        this.filteredOptions = this.allOptions.slice(0, 50);
        this.highlightedIndex = 0;
        return;
      }

      // Filter by code or description
      this.filteredOptions = this.allOptions.filter(option => {
        const codeMatch = option.Code.toLowerCase().includes(searchTerm);
        const descMatch = option.Description.toLowerCase().includes(searchTerm);
        const categoryMatch = option.Category && option.Category.toLowerCase().includes(searchTerm);
        return codeMatch || descMatch || categoryMatch;
      }).slice(0, 50); // Limit results

      this.highlightedIndex = 0;
    },

    selectOption(option) {
      this.selectedValue = option.Code;
      this.query = option.Code + ' - ' + option.Description;
      this.open = false;
      this.highlightedIndex = 0;

      // Trigger change event for form validation
      this.$el.querySelector('input[type="hidden"]').dispatchEvent(new Event('change'));
    },

    highlightNext() {
      this.open = true;
      if (this.highlightedIndex < this.filteredOptions.length - 1) {
        this.highlightedIndex++;
        this.scrollToHighlighted();
      }
    },

    highlightPrevious() {
      this.open = true;
      if (this.highlightedIndex > 0) {
        this.highlightedIndex--;
        this.scrollToHighlighted();
      }
    },

    selectHighlighted() {
      if (this.highlightedIndex >= 0 && this.highlightedIndex < this.filteredOptions.length) {
        this.selectOption(this.filteredOptions[this.highlightedIndex]);
      }
    },

    scrollToHighlighted() {
      this.$nextTick(() => {
        const dropdown = this.$el.querySelector('[x-show="open && filteredOptions.length > 0"]');
        if (!dropdown) return;

        const buttons = dropdown.querySelectorAll('button[type="button"]');
        if (buttons[this.highlightedIndex]) {
          buttons[this.highlightedIndex].scrollIntoView({
            block: 'nearest',
            behavior: 'smooth'
          });
        }
      });
    }
  }));
});
</script>
{{end}}
