{{/*
  Violation Card Component - Displays a safety violation with actions

  Usage:
    {{template "violation-card" (dict
      "ID" "violation-123"
      "SafetyCode" "OSHA 1926.501"
      "Severity" "critical"
      "Status" "pending"
      "Description" "Worker observed without fall protection at elevation"
      "Location" "Near scaffolding, east side"
      "ConfidenceScore" 0.92
      "ShowActions" true
    )}}

  Parameters:
    - ID: Violation ID for HTMX targeting (required)
    - SafetyCode: OSHA/regulation code (e.g., "OSHA 1926.501") (required)
    - Severity: critical, high, medium, low (required)
    - Status: pending, confirmed, dismissed (required)
    - Description: Violation description text (required)
    - Location: Where in photo (optional)
    - ConfidenceScore: AI confidence 0-1 (optional, only shown if provided)
    - ShowActions: Boolean - show confirm/dismiss buttons (default: true)
    - Editable: Boolean - allow inline editing (default: false)
*/}}

{{define "violation-card"}}
{{$showActions := true}}
{{if ne .ShowActions nil}}{{$showActions = .ShowActions}}{{end}}
{{$editable := false}}
{{if .Editable}}{{$editable = .Editable}}{{end}}

<article id="violation-{{.ID}}"
         class="relative rounded-lg border bg-white p-4 shadow-sm transition-all
                {{if eq .Status "confirmed"}}border-green-200 bg-green-50/50{{end}}
                {{if eq .Status "dismissed"}}border-zinc-200 bg-zinc-50/50 opacity-75{{end}}
                {{if eq .Status "pending"}}border-blue-200{{end}}"
         {{if $editable}}x-data="{ editing: false }"{{end}}>

  {{/* Severity indicator bar on left */}}
  <div class="absolute left-0 top-0 bottom-0 w-1 rounded-l-lg
              {{if eq .Severity "critical"}}bg-red-600{{end}}
              {{if eq .Severity "high"}}bg-orange-600{{end}}
              {{if eq .Severity "medium"}}bg-amber-500{{end}}
              {{if eq .Severity "low"}}bg-zinc-400{{end}}">
  </div>

  {{/* Header: Badges and Safety Code */}}
  <div class="flex items-start justify-between gap-2 mb-3">
    <div class="flex items-center gap-2 flex-wrap">
      {{/* Safety Code - Most prominent */}}
      <span class="inline-flex items-center gap-x-1.5 rounded-md px-2 py-1
                   text-sm font-semibold bg-zinc-100 text-zinc-900
                   dark:bg-zinc-800 dark:text-zinc-100">
        {{.SafetyCode}}
      </span>

      {{/* Severity Badge */}}
      {{template "severity-badge" (dict "Severity" .Severity "Size" "sm")}}

      {{/* Status Badge */}}
      {{template "status-badge" (dict "Status" .Status "Size" "sm")}}
    </div>

    {{/* Confidence Score (if AI-generated) */}}
    {{if .ConfidenceScore}}
    <div class="text-xs text-zinc-500 dark:text-zinc-400 whitespace-nowrap">
      {{/* Convert 0.92 to 92% */}}
      {{$percent := printf "%.0f" (mul .ConfidenceScore 100)}}
      {{$percent}}% confidence
    </div>
    {{end}}
  </div>

  {{/* Description */}}
  {{if $editable}}
    <div x-show="!editing">
      <p class="text-sm text-zinc-700 dark:text-zinc-300 mb-2">
        {{.Description}}
      </p>
      <button @click="editing = true"
              type="button"
              class="text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400
                     dark:hover:text-blue-300 flex items-center gap-1">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        Edit
      </button>
    </div>

    <div x-show="editing" x-cloak>
      <textarea
        id="description-{{.ID}}"
        name="description"
        rows="3"
        class="w-full rounded-lg border-zinc-950/10 text-sm mb-2
               dark:border-white/10 dark:bg-zinc-900"
        hx-post="/api/violations/{{.ID}}/update"
        hx-trigger="change"
        hx-target="#violation-{{.ID}}"
        hx-swap="outerHTML">{{.Description}}</textarea>
      <button @click="editing = false"
              type="button"
              class="text-xs text-zinc-600 hover:text-zinc-700 dark:text-zinc-400">
        Done
      </button>
    </div>
  {{else}}
    <p class="text-sm text-zinc-700 dark:text-zinc-300 mb-2">
      {{.Description}}
    </p>
  {{end}}

  {{/* Location (if provided) */}}
  {{if .Location}}
  <div class="flex items-start gap-1.5 mb-3">
    <svg class="w-4 h-4 text-zinc-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
    </svg>
    <span class="text-xs text-zinc-600 dark:text-zinc-400">
      {{.Location}}
    </span>
  </div>
  {{end}}

  {{/* Actions (if enabled) */}}
  {{if $showActions}}
  <div class="flex items-center gap-2 mt-3 pt-3 border-t border-zinc-100 dark:border-zinc-800">
    {{if eq .Status "pending"}}
      {{/* Pending state: Show Confirm and Dismiss */}}
      {{template "button" (dict
        "Content" "Confirm"
        "Size" "sm"
        "Variant" "solid"
        "Color" "green"
        "HXPost" (printf "/api/violations/%s/confirm" .ID)
        "HXTarget" (printf "#violation-%s" .ID)
        "HXSwap" "outerHTML"
      )}}

      {{template "button" (dict
        "Content" "Dismiss"
        "Size" "sm"
        "Variant" "outline"
        "HXPost" (printf "/api/violations/%s/dismiss" .ID)
        "HXTarget" (printf "#violation-%s" .ID)
        "HXSwap" "outerHTML"
      )}}
    {{else if eq .Status "confirmed"}}
      {{/* Confirmed state: Show undo option */}}
      <div class="flex items-center gap-2 w-full">
        <svg class="w-4 h-4 text-green-600 dark:text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span class="text-sm text-green-700 dark:text-green-300 flex-1">
          Confirmed
        </span>
        {{template "button" (dict
          "Content" "Undo"
          "Size" "sm"
          "Variant" "plain"
          "HXPost" (printf "/api/violations/%s/pending" .ID)
          "HXTarget" (printf "#violation-%s" .ID)
          "HXSwap" "outerHTML"
        )}}
      </div>
    {{else if eq .Status "dismissed"}}
      {{/* Dismissed state: Show restore option */}}
      <div class="flex items-center gap-2 w-full">
        <svg class="w-4 h-4 text-zinc-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span class="text-sm text-zinc-500 dark:text-zinc-400 flex-1">
          Dismissed
        </span>
        {{template "button" (dict
          "Content" "Restore"
          "Size" "sm"
          "Variant" "plain"
          "HXPost" (printf "/api/violations/%s/pending" .ID)
          "HXTarget" (printf "#violation-%s" .ID)
          "HXSwap" "outerHTML"
        )}}
      </div>
    {{end}}

    {{/* Loading indicator for HTMX requests */}}
    <div id="saving-{{.ID}}" class="htmx-indicator">
      {{template "spinner" (dict "Size" "sm")}}
    </div>
  </div>
  {{end}}
</article>
{{end}}
