{{template "base" .}}

{{define "title"}}Photo Review - Aletheia{{end}}

{{define "content"}}
<div class="container">
  <div class="stack" style="margin-top: var(--space-xl);">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: start;">
      <div>
        <h1>Photo Review</h1>
        <p style="color: #666; margin-top: var(--space-xs);">
          <strong>Inspection:</strong> #{{.Inspection.ID.String}}
          {{if .ProjectName}} | <strong>Project:</strong> {{.ProjectName}}{{end}}
        </p>
      </div>
      <a href="/inspections/{{.Inspection.ID.String}}" class="btn-secondary">Back to Inspection</a>
    </div>

    <div style="display: grid; gap: var(--space-lg); grid-template-columns: 1fr 1fr;">
      <!-- Photo Display -->
      <div class="card">
        <h2 style="margin-bottom: var(--space-md);">Photo</h2>
        <img
          src="{{.Photo.StorageUrl}}"
          alt="Inspection photo"
          style="width: 100%; height: auto; border-radius: 4px; margin-bottom: var(--space-sm);">
        <p style="color: #666; font-size: 0.875rem;">
          Uploaded: {{.Photo.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}
        </p>
      </div>

      <!-- Violations List -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
          <h2 style="margin: 0;">Detected Violations</h2>
          <span style="color: #666; font-size: 0.875rem;">{{len .Violations}} violation(s)</span>
        </div>

        {{if .Violations}}
          <div class="stack">
            {{range .Violations}}
              <div id="violation-{{.ID.String}}" class="card" style="padding: var(--space-md); background:
                {{if eq .Status "confirmed"}}#d1fae5
                {{else if eq .Status "dismissed"}}#f3f4f6
                {{else}}#fef2f2{{end}}; border-left: 4px solid
                {{if eq .Status "confirmed"}}#059669
                {{else if eq .Status "dismissed"}}#9ca3af
                {{else if eq .Severity "critical"}}#dc2626
                {{else if eq .Severity "high"}}#f97316
                {{else if eq .Severity "medium"}}#fbbf24
                {{else}}#94a3b8{{end}};">

                <!-- Violation Header -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-sm);">
                  <div style="display: flex; gap: var(--space-xs); align-items: center;">
                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;
                      {{if eq .Severity "critical"}}background: #dc2626; color: white;
                      {{else if eq .Severity "high"}}background: #f97316; color: white;
                      {{else if eq .Severity "medium"}}background: #fbbf24; color: #78350f;
                      {{else}}background: #94a3b8; color: white;{{end}}">
                      {{.Severity}}
                    </span>
                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;
                      {{if eq .Status "confirmed"}}background: #059669; color: white;
                      {{else if eq .Status "dismissed"}}background: #6b7280; color: white;
                      {{else}}background: #3b82f6; color: white;{{end}}">
                      {{.Status}}
                    </span>
                  </div>
                  <span style="font-size: 0.75rem; color: #64748b;">
                    {{printf "%.0f%%" (mul .ConfidenceScore 100)}} confidence
                  </span>
                </div>

                <!-- Regulation Citation (prominent) -->
                {{if .SafetyCodeID.Valid}}
                  <div style="margin-bottom: var(--space-sm); padding: var(--space-sm); background: #1e3a8a; border-radius: 4px;">
                    <p style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin: 0 0 var(--space-2xs) 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                      Regulation Violated
                    </p>
                    <p style="font-size: 0.95rem; color: white; margin: 0; font-weight: 700; font-family: monospace;">
                      üìã {{index $.SafetyCodeMap (.SafetyCodeID.String)}}
                    </p>
                  </div>
                {{end}}

                <!-- Violation Description -->
                <p style="font-size: 0.95rem; color: #1f2937; margin-bottom: var(--space-sm); line-height: 1.5;">
                  {{.Description}}
                </p>

                {{if .Location.Valid}}
                  <p style="font-size: 0.875rem; color: #64748b; margin-bottom: var(--space-sm);">
                    <strong>üìç Location:</strong> {{.Location.String}}
                  </p>
                {{end}}

                <!-- Action Buttons -->
                {{if eq .Status "pending"}}
                  <div style="display: flex; gap: var(--space-sm); margin-top: var(--space-md);">
                    <button
                      hx-post="/api/violations/{{.ID.String}}/confirm"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="btn-primary"
                      style="flex: 1;">
                      ‚úì Confirm Violation
                    </button>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/dismiss"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="btn-secondary"
                      style="flex: 1;">
                      ‚úó Dismiss
                    </button>
                  </div>
                {{else if eq .Status "confirmed"}}
                  <div style="margin-top: var(--space-md);">
                    <p style="color: #059669; font-weight: 600; font-size: 0.875rem; margin-bottom: var(--space-xs);">
                      ‚úì Confirmed by inspector
                    </p>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/dismiss"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="btn-secondary"
                      style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                      Change to Dismissed
                    </button>
                  </div>
                {{else if eq .Status "dismissed"}}
                  <div style="margin-top: var(--space-md);">
                    <p style="color: #6b7280; font-weight: 600; font-size: 0.875rem; margin-bottom: var(--space-xs);">
                      ‚úó Dismissed by inspector
                    </p>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/confirm"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="btn-primary"
                      style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                      Change to Confirmed
                    </button>
                  </div>
                {{end}}
              </div>
            {{end}}
          </div>
        {{else}}
          <div style="text-align: center; padding: var(--space-2xl); color: #666;">
            <p>No violations detected for this photo.</p>
            <p style="font-size: 0.875rem; margin-top: var(--space-xs);">This photo passed all safety checks.</p>
          </div>
        {{end}}
      </div>
    </div>

    <!-- Re-analyze Section -->
    <div class="card">
      <h2 style="margin-bottom: var(--space-sm);">Re-analyze Photo</h2>
      <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-md);">
        If you believe there are additional violations or the AI missed something, provide additional context and re-analyze the photo.
      </p>

      <div x-data="{ analyzing: false }">
        <textarea
          id="reanalyze-context"
          name="context"
          placeholder="e.g., Look for missing hard hats on workers near the scaffolding..."
          style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; resize: vertical; margin-bottom: var(--space-sm);"
        ></textarea>

        <button
          hx-post="/api/photos/analyze"
          hx-include="#reanalyze-context"
          hx-vals='{"photo_id": "{{.Photo.ID.String}}"}'
          hx-trigger="click"
          @click="analyzing = true"
          hx-indicator="#analyze-status"
          class="btn-primary"
          :disabled="analyzing"
          style="width: 100%;">
          <span x-show="!analyzing">Re-analyze with Context</span>
          <span x-show="analyzing">Analyzing...</span>
        </button>

        <div id="analyze-status" style="margin-top: var(--space-sm); display: none;">
          <div style="padding: var(--space-sm); background: #dbeafe; border-radius: 4px; color: #1e40af; font-size: 0.875rem; display: flex; align-items: center; gap: var(--space-xs);">
            <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Analysis in progress. This may take 30-60 seconds...
          </div>
        </div>

        <div id="analyze-complete" style="margin-top: var(--space-sm); display: none;">
          <div style="padding: var(--space-sm); background: #d1fae5; border-radius: 4px; color: #059669; font-size: 0.875rem;">
            ‚úì Analysis complete! Refresh the page to see updated violations.
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
      <a href="/inspections/{{.Inspection.ID.String}}" class="btn-secondary">Back to Inspection</a>
      <a href="/projects/{{.Inspection.ProjectID.String}}" class="btn-secondary">View Project</a>
    </div>

    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>

    <script>
      // Show status when analysis starts
      document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.pathInfo.requestPath.includes('/api/photos/analyze')) {
          document.getElementById('analyze-status').style.display = 'block';
          document.getElementById('analyze-complete').style.display = 'none';
        }
      });

      // Show complete message when analysis finishes
      document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.pathInfo.requestPath.includes('/api/photos/analyze')) {
          document.getElementById('analyze-status').style.display = 'none';
          if (evt.detail.successful) {
            document.getElementById('analyze-complete').style.display = 'block';
            // Clear the textarea
            document.getElementById('reanalyze-context').value = '';
            // Optionally reload after a delay
            setTimeout(function() {
              window.location.reload();
            }, 2000);
          }
        }
      });
    </script>
  </div>
</div>
{{end}}
