{{template "base" .}}

{{define "title"}}Photo Review - Aletheia{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  {{/* Breadcrumb */}}
  {{template "breadcrumb" (dict
    "Items" (slice
      (dict "Label" "Dashboard" "URL" "/dashboard")
      (dict "Label" "Projects" "URL" "/projects")
      (dict "Label" .ProjectName "URL" (printf "/projects/%v" .ProjectID))
      (dict "Label" "Inspection" "URL" (printf "/inspections/%v" .Inspection.ID))
      (dict "Label" "Photo" "URL" "")
    )
  )}}

  <!-- Header -->
  <div class="mt-6">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl/9 font-bold text-zinc-950 dark:text-white sm:text-4xl/10">
          Photo Review
        </h1>
        <p class="mt-2 text-sm/6 text-zinc-600 dark:text-zinc-400">
          <span class="font-medium">Inspection:</span> #{{.Inspection.ID.String}}
          {{if .ProjectName}}
            <span class="mx-2 text-zinc-400">‚Ä¢</span>
            <span class="font-medium">Project:</span> {{.ProjectName}}
          {{end}}
        </p>
      </div>
      <a href="/inspections/{{.Inspection.ID.String}}">
        {{template "button" (dict "Content" "Back to Inspection" "Variant" "outline")}}
      </a>
    </div>
  </div>

  <div class="px-gutter pb-16">
    <div class="grid gap-8 lg:grid-cols-2">
      <!-- Photo Display Card -->
      <div class="rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white mb-6">
          Photo
        </h2>
        <img
          src="{{.Photo.StorageUrl}}"
          alt="Inspection photo"
          class="w-full h-auto rounded-lg ring-1 ring-zinc-950/10 dark:ring-white/20 mb-4">
        <p class="text-sm/6 text-zinc-500 dark:text-zinc-400">
          Uploaded: {{.Photo.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}
        </p>
      </div>

      <!-- Violations List Card -->
      <div class="rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white">
            Detected Violations
          </h2>
          <span class="text-sm/6 text-zinc-500 dark:text-zinc-400">
            {{len .Violations}} violation(s)
          </span>
        </div>

        {{if .Violations}}
          <div class="space-y-4">
            {{range .Violations}}
              <div id="violation-{{.ID.String}}" class="rounded-lg border-l-4 p-4
                {{if eq .Status "confirmed"}}bg-green-50 border-green-600 dark:bg-green-950/30 dark:border-green-500
                {{else if eq .Status "dismissed"}}bg-zinc-100 border-zinc-400 dark:bg-zinc-800 dark:border-zinc-600
                {{else if eq .Severity "critical"}}bg-red-50 border-red-600 dark:bg-red-950/30 dark:border-red-500
                {{else if eq .Severity "high"}}bg-orange-50 border-orange-600 dark:bg-orange-950/30 dark:border-orange-500
                {{else if eq .Severity "medium"}}bg-yellow-50 border-yellow-600 dark:bg-yellow-950/30 dark:border-yellow-500
                {{else}}bg-zinc-100 border-zinc-400 dark:bg-zinc-800 dark:border-zinc-600{{end}}">

                <!-- Badges Row -->
                <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
                  <div class="flex items-center gap-2">
                    <!-- Severity Badge -->
                    {{if eq .Severity "critical"}}
                      {{template "badge" (dict "Content" .Severity "Color" "red" "Size" "sm")}}
                    {{else if eq .Severity "high"}}
                      {{template "badge" (dict "Content" .Severity "Color" "orange" "Size" "sm")}}
                    {{else if eq .Severity "medium"}}
                      {{template "badge" (dict "Content" .Severity "Color" "yellow" "Size" "sm")}}
                    {{else}}
                      {{template "badge" (dict "Content" .Severity "Color" "zinc" "Size" "sm")}}
                    {{end}}

                    <!-- Status Badge -->
                    {{if eq .Status "confirmed"}}
                      {{template "badge" (dict "Content" .Status "Color" "green" "Size" "sm")}}
                    {{else if eq .Status "dismissed"}}
                      {{template "badge" (dict "Content" .Status "Color" "zinc" "Size" "sm")}}
                    {{else}}
                      {{template "badge" (dict "Content" .Status "Color" "blue" "Size" "sm")}}
                    {{end}}
                  </div>

                  <!-- Confidence Score -->
                  <span class="text-xs text-zinc-500 dark:text-zinc-400">
                    {{printf "%.0f%%" (mul .ConfidenceScore 100)}} confidence
                  </span>
                </div>

                <!-- Safety Code Citation -->
                {{if .SafetyCodeID.Valid}}
                  <div class="mb-3 rounded-lg bg-blue-900 p-3">
                    <p class="text-xs font-semibold uppercase tracking-wide text-blue-200 mb-1">
                      Regulation Violated
                    </p>
                    <p class="text-base font-bold text-white font-mono">
                      üìã {{index $.SafetyCodeMap (.SafetyCodeID.String)}}
                    </p>
                  </div>
                {{end}}

                <!-- Description -->
                <p class="text-sm/6 text-zinc-900 dark:text-zinc-100 mb-3">
                  {{.Description}}
                </p>

                <!-- Location -->
                {{if .Location.Valid}}
                  <p class="text-sm/6 text-zinc-600 dark:text-zinc-400 mb-3">
                    <span class="font-medium">üìç Location:</span> {{.Location.String}}
                  </p>
                {{end}}

                <!-- Action Buttons -->
                {{if eq .Status "pending"}}
                  <div class="flex gap-3 mt-4">
                    <button
                      hx-post="/api/violations/{{.ID.String}}/confirm"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="flex-1 rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-500 dark:bg-green-500 dark:hover:bg-green-400">
                      ‚úì Confirm Violation
                    </button>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/dismiss"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="flex-1 rounded-lg border border-zinc-950/10 bg-white px-4 py-2 text-sm font-semibold text-zinc-700 hover:bg-zinc-50 dark:border-white/10 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">
                      ‚úó Dismiss
                    </button>
                  </div>
                {{else if eq .Status "confirmed"}}
                  <div class="mt-4">
                    <p class="text-sm font-semibold text-green-700 dark:text-green-400 mb-2">
                      ‚úì Confirmed by inspector
                    </p>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/dismiss"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="rounded-lg border border-zinc-950/10 bg-white px-3 py-1.5 text-sm font-semibold text-zinc-700 hover:bg-zinc-50 dark:border-white/10 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">
                      Change to Dismissed
                    </button>
                  </div>
                {{else if eq .Status "dismissed"}}
                  <div class="mt-4">
                    <p class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">
                      ‚úó Dismissed by inspector
                    </p>
                    <button
                      hx-post="/api/violations/{{.ID.String}}/confirm"
                      hx-target="#violation-{{.ID.String}}"
                      hx-swap="outerHTML"
                      class="rounded-lg bg-green-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-green-500 dark:bg-green-500 dark:hover:bg-green-400">
                      Change to Confirmed
                    </button>
                  </div>
                {{end}}
              </div>
            {{end}}
          </div>
        {{else}}
          <div class="text-center py-12">
            <p class="text-sm text-zinc-500 dark:text-zinc-400">No violations detected for this photo.</p>
            <p class="mt-1 text-xs text-zinc-400 dark:text-zinc-500">This photo passed all safety checks.</p>
          </div>
        {{end}}
      </div>
    </div>

    <!-- Re-analyze Section -->
    <div class="mt-8 rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
      <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white mb-2">
        Re-analyze Photo
      </h2>
      <p class="text-sm/6 text-zinc-600 dark:text-zinc-400 mb-6">
        If you believe there are additional violations or the AI missed something, provide additional context and re-analyze the photo.
      </p>

      <div x-data="{ analyzing: false }">
        {{template "textarea" (dict
          "Name" "context"
          "ID" "reanalyze-context"
          "Rows" 4
          "Placeholder" "e.g., Look for missing hard hats on workers near the scaffolding..."
          "Class" "mb-4"
        )}}

        <button
          hx-post="/api/photos/analyze"
          hx-include="#reanalyze-context"
          hx-vals='{"photo_id": "{{.Photo.ID.String}}"}'
          hx-trigger="click"
          @click="analyzing = true"
          hx-indicator="#analyze-status"
          :disabled="analyzing"
          class="w-full rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-500 disabled:opacity-50 dark:bg-blue-500 dark:hover:bg-blue-400">
          <span x-show="!analyzing">Re-analyze with Context</span>
          <span x-show="analyzing" x-cloak>Analyzing...</span>
        </button>

        <div id="analyze-status" class="mt-4 hidden">
          <div class="flex items-center gap-3 rounded-lg bg-blue-50 px-4 py-3 text-sm/6 text-blue-700 dark:bg-blue-950/50 dark:text-blue-300">
            <svg class="size-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Analysis in progress. This may take 30-60 seconds...
          </div>
        </div>

        <div id="analyze-complete" class="mt-4 hidden">
          <div class="rounded-lg bg-green-50 px-4 py-3 text-sm/6 text-green-700 dark:bg-green-950/50 dark:text-green-300">
            ‚úì Analysis complete! Refresh the page to see updated violations.
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Violation Entry Section -->
    <div class="mt-8 rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
      <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white mb-2">
        Add Manual Violation
      </h2>
      <p class="text-sm/6 text-zinc-600 dark:text-zinc-400 mb-6">
        If you've identified a violation that the AI missed, you can manually add it here.
      </p>

      <form id="manual-violation-form" x-data="{ submitting: false }" class="space-y-4">
        <!-- Safety Code -->
        <div class="space-y-1">
          <label for="safety-code" class="text-base/6 text-zinc-950 sm:text-sm/6 dark:text-white font-medium">
            Safety Code/Regulation <span class="text-red-500">*</span>
          </label>
          {{template "input" (dict
            "Type" "text"
            "Name" "safety_code"
            "ID" "safety-code"
            "Required" true
            "Placeholder" "e.g., OSHA 1926.501"
          )}}
        </div>

        <!-- Description -->
        <div class="space-y-1">
          <label for="description" class="text-base/6 text-zinc-950 sm:text-sm/6 dark:text-white font-medium">
            Description <span class="text-red-500">*</span>
          </label>
          {{template "textarea" (dict
            "Name" "description"
            "ID" "description"
            "Required" true
            "Rows" 4
            "Placeholder" "Describe the safety violation you observed..."
          )}}
        </div>

        <!-- Severity and Location Grid -->
        <div class="grid gap-4 sm:grid-cols-2">
          <!-- Severity -->
          <div class="space-y-1">
            <label for="severity" class="text-base/6 text-zinc-950 sm:text-sm/6 dark:text-white font-medium">
              Severity <span class="text-red-500">*</span>
            </label>
            <select
              id="severity"
              name="severity"
              required
              class="relative block w-full appearance-none rounded-lg border
                     px-[calc(theme(spacing.3.5)-1px)] py-[calc(theme(spacing.2.5)-1px)]
                     sm:px-[calc(theme(spacing.3)-1px)] sm:py-[calc(theme(spacing.1.5)-1px)]
                     text-base/6 text-zinc-950 sm:text-sm/6
                     border-zinc-950/10 hover:border-zinc-950/20
                     dark:border-white/10 dark:text-white dark:hover:border-white/20
                     bg-white dark:bg-white/5
                     focus:outline focus:outline-2 focus:-outline-offset-1 focus:outline-blue-500">
              <option value="">Select severity...</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>

          <!-- Location -->
          <div class="space-y-1">
            <label for="location" class="text-base/6 text-zinc-950 sm:text-sm/6 dark:text-white font-medium">
              Location (optional)
            </label>
            {{template "input" (dict
              "Type" "text"
              "Name" "location"
              "ID" "location"
              "Placeholder" "e.g., Near scaffolding, left side"
            )}}
          </div>
        </div>

        <input type="hidden" name="photo_id" value="{{.Photo.ID.String}}">

        <button
          type="submit"
          hx-post="/api/violations/manual"
          hx-include="#manual-violation-form"
          hx-target="#manual-violation-status"
          hx-swap="innerHTML"
          @click="submitting = true"
          :disabled="submitting"
          class="w-full rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-500 disabled:opacity-50 dark:bg-blue-500 dark:hover:bg-blue-400">
          <span x-show="!submitting">Add Violation</span>
          <span x-show="submitting" x-cloak>Adding...</span>
        </button>

        <div id="manual-violation-status"></div>
      </form>
    </div>

    <!-- Bottom Actions -->
    <div class="mt-8 flex gap-4 flex-wrap">
      <a href="/inspections/{{.Inspection.ID.String}}">
        {{template "button" (dict "Content" "Back to Inspection" "Variant" "outline")}}
      </a>
      <a href="/projects/{{.Inspection.ProjectID.String}}">
        {{template "button" (dict "Content" "View Project" "Variant" "outline")}}
      </a>
    </div>
  </div>
</div>

<script>
  // Show status when analysis starts
  document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath.includes('/api/photos/analyze')) {
      document.getElementById('analyze-status').classList.remove('hidden');
      document.getElementById('analyze-complete').classList.add('hidden');
    }
  });

  // Show complete message when analysis finishes
  document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath.includes('/api/photos/analyze')) {
      document.getElementById('analyze-status').classList.add('hidden');
      if (evt.detail.successful) {
        document.getElementById('analyze-complete').classList.remove('hidden');
        // Clear the textarea
        document.getElementById('reanalyze-context').value = '';
        // Reload after a delay
        setTimeout(function() {
          window.location.reload();
        }, 2000);
      }
    }
  });
</script>
{{end}}
