{{template "base" .}}

{{define "title"}}Inspection #{{.Inspection.ID}} - Aletheia{{end}}

{{define "content"}}
<div class="container">
  <div class="stack" style="margin-top: var(--space-xl);">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: start;">
      <div>
        <h1>Inspection #{{.Inspection.ID}}</h1>
        <p style="color: #666; margin-top: var(--space-xs);">
          <strong>Project:</strong> {{.ProjectName}}
          {{if .ProjectLocation}} | <strong>Location:</strong> {{.ProjectLocation}}{{end}}
        </p>
      </div>
      <span style="padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;
        {{if eq .Inspection.Status "draft"}}background: #f3f4f6; color: #374151;
        {{else if eq .Inspection.Status "in_progress"}}background: #dbeafe; color: #1e40af;
        {{else if eq .Inspection.Status "completed"}}background: #d1fae5; color: #065f46;
        {{else}}background: #fef3c7; color: #92400e;{{end}}">
        {{.Inspection.Status}}
      </span>
    </div>

    <!-- Inspection Details Card -->
    <div class="card">
      <h2>Inspection Details</h2>
      <div style="display: grid; gap: var(--space-md); margin-top: var(--space-md);">
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Inspector ID:</strong></p>
          <p>{{.Inspection.InspectorID}}</p>
        </div>
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Created:</strong></p>
          <p>{{.Inspection.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</p>
        </div>
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Last Updated:</strong></p>
          <p>{{.Inspection.UpdatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</p>
        </div>
      </div>
    </div>

    <!-- Photo Upload Section -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
        <h2 style="margin: 0;">Photos</h2>
        <div style="display: flex; align-items: center; gap: var(--space-sm);">
          <span style="color: #666; font-size: 0.875rem;">{{len .Photos}} photo(s)</span>
          <label for="photo-upload" class="btn-primary" style="margin: 0; cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-xs);">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Photo
          </label>
        </div>
      </div>

      <!-- Upload Form (Hidden) -->
      <form
        hx-post="/api/upload"
        hx-encoding="multipart/form-data"
        hx-target="#photo-list"
        hx-swap="afterbegin"
        id="upload-form"
        style="display: none;">
        <input type="hidden" name="inspection_id" value="{{.Inspection.ID}}">
        <input
          type="file"
          id="photo-upload"
          name="image"
          accept="image/jpeg,image/png,image/webp"
          onchange="document.getElementById('upload-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }))">
      </form>

      <div id="upload-status" style="margin-bottom: var(--space-md); display: none;">
        <div style="padding: var(--space-sm); background: #dbeafe; border-radius: 4px; color: #1e40af; font-size: 0.875rem; display: flex; align-items: center; gap: var(--space-xs);">
          <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Uploading photo...
        </div>
      </div>

      <!-- Photo Grid -->
      <div id="photo-list" class="grid">
        {{range .Photos}}
          <div class="card" style="padding: var(--space-sm);">
            <a href="/photos/{{.ID.String}}">
              <img
                src="{{if .ThumbnailUrl.Valid}}{{.ThumbnailUrl.String}}{{else}}{{.StorageUrl}}{{end}}"
                alt="Inspection photo"
                style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: var(--space-sm);">
            </a>
            <div style="margin-bottom: var(--space-sm);">
              <p style="color: #666; font-size: 0.75rem; margin: 0;">
                {{.CreatedAt.Time.Format "Jan 2, 3:04 PM"}}
              </p>
            </div>

            {{$violations := index $.ViolationsByPhoto (.ID.String)}}
            {{if $violations}}
              <!-- Violations detected -->
              <div style="margin-bottom: var(--space-sm); padding: var(--space-sm); background:
                {{if eq (index $violations 0).Status "confirmed"}}#d1fae5
                {{else if eq (index $violations 0).Status "dismissed"}}#f3f4f6
                {{else}}#fef2f2{{end}}; border-left: 4px solid
                {{if eq (index $violations 0).Status "confirmed"}}#059669
                {{else if eq (index $violations 0).Status "dismissed"}}#9ca3af
                {{else}}#dc2626{{end}}; border-radius: 4px;">
                <p style="font-weight: 600; font-size: 0.875rem; margin-bottom: var(--space-xs); color:
                  {{if eq (index $violations 0).Status "confirmed"}}#059669
                  {{else if eq (index $violations 0).Status "dismissed"}}#6b7280
                  {{else}}#dc2626{{end}}">
                  {{len $violations}} Violation(s) Detected
                </p>
                {{range $violations}}
                  <div style="margin-bottom: var(--space-xs); padding: var(--space-xs); background: white; border-radius: 4px;">
                    <!-- Regulation Citation (prominent) -->
                    {{if .SafetyCodeID.Valid}}
                      <div style="margin-bottom: var(--space-2xs);">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.75rem; font-weight: 700; background: #1e3a8a; color: white; font-family: monospace;">
                          üìã {{index $.SafetyCodeMap (.SafetyCodeID.String)}}
                        </span>
                      </div>
                    {{end}}

                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2xs); flex-wrap: wrap; gap: var(--space-2xs);">
                      <div style="display: flex; gap: var(--space-2xs); align-items: center;">
                        <span style="padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;
                          {{if eq .Severity "critical"}}background: #dc2626; color: white;
                          {{else if eq .Severity "high"}}background: #f97316; color: white;
                          {{else if eq .Severity "medium"}}background: #fbbf24; color: #78350f;
                          {{else}}background: #94a3b8; color: white;{{end}}">
                          {{.Severity}}
                        </span>
                        <span style="padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;
                          {{if eq .Status "confirmed"}}background: #059669; color: white;
                          {{else if eq .Status "dismissed"}}background: #6b7280; color: white;
                          {{else}}background: #3b82f6; color: white;{{end}}">
                          {{.Status}}
                        </span>
                      </div>
                      <span style="font-size: 0.7rem; color: #64748b;">
                        {{printf "%.0f%%" (mul .ConfidenceScore 100)}} confidence
                      </span>
                    </div>
                    <p style="font-size: 0.8rem; color: #334155; margin: 0;">
                      {{.Description}}
                    </p>
                    {{if .Location.Valid}}
                      <p style="font-size: 0.7rem; color: #64748b; margin-top: var(--space-2xs); margin-bottom: 0;">
                        üìç Location: {{.Location.String}}
                      </p>
                    {{end}}
                  </div>
                {{end}}
              </div>
            {{end}}

            <div style="display: flex; flex-direction: column; gap: var(--space-xs);">
              <!-- Context Input (collapsible) -->
              <div x-data="{ showContext: false }" style="width: 100%;">
                <button
                  @click="showContext = !showContext"
                  type="button"
                  class="btn-secondary"
                  style="padding: 0.25rem 0.5rem; font-size: 0.75rem; width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                  <span>Add Context (optional)</span>
                  <svg x-show="!showContext" style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                  <svg x-show="showContext" style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </button>
                <div x-show="showContext" x-collapse style="margin-top: var(--space-xs);">
                  <textarea
                    id="context-{{.ID.String}}"
                    name="context"
                    placeholder="e.g., Check for missing PPE on workers near heavy equipment..."
                    style="width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem; resize: vertical;"
                  ></textarea>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap;">
                <button
                  hx-post="/api/photos/analyze"
                  hx-include="#context-{{.ID.String}}"
                  hx-vals='{"photo_id": "{{.ID.String}}"}'
                  hx-target="closest .card"
                  hx-swap="outerHTML"
                  class="btn-primary"
                  style="padding: 0.25rem 0.5rem; font-size: 0.75rem; flex: 1;">
                  Analyze
                </button>
                <button
                  hx-delete="/api/photos/{{.ID.String}}"
                  hx-confirm="Are you sure you want to delete this photo?"
                  hx-target="closest .card"
                  hx-swap="outerHTML swap:1s"
                  class="btn-secondary"
                  style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                  Delete
                </button>
              </div>
            </div>
          </div>
        {{else}}
          <div style="text-align: center; padding: var(--space-2xl); color: #666; grid-column: 1 / -1;">
            <p>No photos uploaded yet.</p>
          </div>
        {{end}}
      </div>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
      <a href="/projects/{{.Inspection.ProjectID}}/inspections" class="btn-secondary">Back to Inspections</a>
      <a href="/projects/{{.Inspection.ProjectID}}" class="btn-secondary">View Project</a>
    </div>
  </div>
</div>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // Show upload status when form is submitted
  document.getElementById('upload-form').addEventListener('htmx:beforeRequest', function() {
    document.getElementById('upload-status').style.display = 'block';
  });

  // Hide upload status and reset form when complete
  document.getElementById('upload-form').addEventListener('htmx:afterRequest', function(event) {
    document.getElementById('upload-status').style.display = 'none';
    if (event.detail.successful) {
      document.getElementById('photo-upload').value = '';
    }
  });
</script>
{{end}}
