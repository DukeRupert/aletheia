{{template "base" .}}

{{define "title"}}Inspection #{{.Inspection.ID}} - Aletheia{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl">
  <!-- Header with Status Badge -->
  <div class="px-gutter pt-8 pb-6">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl/9 font-bold text-zinc-950 dark:text-white sm:text-4xl/10">
          Inspection #{{.Inspection.ID}}
        </h1>
        <p class="mt-2 text-sm/6 text-zinc-600 dark:text-zinc-400">
          <span class="font-medium">Project:</span> {{.ProjectName}}
          {{if .ProjectLocation}}
            <span class="mx-2 text-zinc-400">‚Ä¢</span>
            <span class="font-medium">Location:</span> {{.ProjectLocation}}
          {{end}}
        </p>
      </div>
      <div>
        {{if eq .Inspection.Status "draft"}}
          {{template "badge" (dict "Content" .Inspection.Status "Color" "zinc")}}
        {{else if eq .Inspection.Status "in_progress"}}
          {{template "badge" (dict "Content" .Inspection.Status "Color" "blue")}}
        {{else if eq .Inspection.Status "completed"}}
          {{template "badge" (dict "Content" .Inspection.Status "Color" "green")}}
        {{else}}
          {{template "badge" (dict "Content" .Inspection.Status "Color" "yellow")}}
        {{end}}
      </div>
    </div>
  </div>

  <div class="px-gutter pb-16">
    <div class="space-y-8">
      <!-- Inspection Details Card -->
      <div class="rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white">
          Inspection Details
        </h2>

        <dl class="mt-6 grid gap-6 sm:grid-cols-3">
          <div>
            <dt class="text-sm/6 font-medium text-zinc-950 dark:text-white">Inspector ID</dt>
            <dd class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">{{.Inspection.InspectorID}}</dd>
          </div>
          <div>
            <dt class="text-sm/6 font-medium text-zinc-950 dark:text-white">Created</dt>
            <dd class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">{{.Inspection.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</dd>
          </div>
          <div>
            <dt class="text-sm/6 font-medium text-zinc-950 dark:text-white">Last Updated</dt>
            <dd class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">{{.Inspection.UpdatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</dd>
          </div>
        </dl>
      </div>

      <!-- Photos Section -->
      <div class="rounded-3xl bg-white p-8 shadow-lg ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-lg/7 font-semibold text-zinc-950 dark:text-white">Photos</h2>
            <p class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">{{len .Photos}} photo(s) uploaded</p>
          </div>
          <label for="photo-upload" class="cursor-pointer">
            {{template "button" (dict
              "Content" "Add Photo"
              "Variant" "solid"
              "Color" "blue"
              "Icon" "<svg class=\"size-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4v16m8-8H4\"></path></svg>"
            )}}
          </label>
        </div>

        <!-- Upload Form (Hidden) -->
        <form
          hx-post="/api/upload"
          hx-encoding="multipart/form-data"
          hx-target="#photo-list"
          hx-swap="afterbegin"
          id="upload-form"
          class="hidden">
          <input type="hidden" name="inspection_id" value="{{.Inspection.ID}}">
          <input
            type="file"
            id="photo-upload"
            name="image"
            accept="image/jpeg,image/png,image/webp"
            onchange="document.getElementById('upload-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }))">
        </form>

        <!-- Upload Status -->
        <div id="upload-status" class="mt-6 hidden">
          <div class="flex items-center gap-3 rounded-lg bg-blue-50 px-4 py-3 text-sm/6 text-blue-700 dark:bg-blue-950/50 dark:text-blue-300">
            <svg class="size-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Uploading photo...
          </div>
        </div>

        <!-- Photo Grid -->
        <div id="photo-list" class="mt-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {{range .Photos}}
            <div class="rounded-xl bg-zinc-50 p-4 ring-1 ring-zinc-950/5 dark:bg-zinc-800/50 dark:ring-white/10">
              <!-- Photo Thumbnail -->
              <a href="/photos/{{.ID.String}}" class="group block">
                <img
                  src="{{if .ThumbnailUrl.Valid}}{{.ThumbnailUrl.String}}{{else}}{{.StorageUrl}}{{end}}"
                  alt="Inspection photo"
                  class="aspect-[4/3] w-full rounded-lg object-cover ring-1 ring-zinc-950/10 dark:ring-white/20 group-hover:opacity-90 transition-opacity">
              </a>

              <!-- Timestamp -->
              <p class="mt-3 text-xs/5 text-zinc-500 dark:text-zinc-400">
                {{.CreatedAt.Time.Format "Jan 2, 3:04 PM"}}
              </p>

              {{$violations := index $.ViolationsByPhoto (.ID.String)}}
              {{if $violations}}
                <!-- Violations Section -->
                <div class="mt-3 rounded-lg border-l-4 p-3
                  {{if eq (index $violations 0).Status "confirmed"}}bg-green-50 border-green-600 dark:bg-green-950/30 dark:border-green-500
                  {{else if eq (index $violations 0).Status "dismissed"}}bg-zinc-100 border-zinc-400 dark:bg-zinc-800 dark:border-zinc-600
                  {{else}}bg-red-50 border-red-600 dark:bg-red-950/30 dark:border-red-500{{end}}">

                  <p class="text-sm/6 font-semibold mb-3
                    {{if eq (index $violations 0).Status "confirmed"}}text-green-700 dark:text-green-400
                    {{else if eq (index $violations 0).Status "dismissed"}}text-zinc-600 dark:text-zinc-400
                    {{else}}text-red-700 dark:text-red-400{{end}}">
                    {{len $violations}} Violation(s) Detected
                  </p>

                  <!-- Individual Violations -->
                  <div class="space-y-2">
                    {{range $violations}}
                      <div class="rounded-lg bg-white p-3 dark:bg-zinc-900">
                        <!-- Safety Code Citation -->
                        {{if .SafetyCodeID.Valid}}
                          <div class="mb-2">
                            <span class="inline-flex items-center gap-1 rounded-md bg-blue-900 px-2 py-1 text-xs font-bold text-white font-mono">
                              üìã {{index $.SafetyCodeMap (.SafetyCodeID.String)}}
                            </span>
                          </div>
                        {{end}}

                        <!-- Badges Row -->
                        <div class="flex items-center justify-between gap-2 flex-wrap mb-2">
                          <div class="flex items-center gap-1.5">
                            <!-- Severity Badge -->
                            {{if eq .Severity "critical"}}
                              {{template "badge" (dict "Content" .Severity "Color" "red" "Size" "xs")}}
                            {{else if eq .Severity "high"}}
                              {{template "badge" (dict "Content" .Severity "Color" "orange" "Size" "xs")}}
                            {{else if eq .Severity "medium"}}
                              {{template "badge" (dict "Content" .Severity "Color" "yellow" "Size" "xs")}}
                            {{else}}
                              {{template "badge" (dict "Content" .Severity "Color" "zinc" "Size" "xs")}}
                            {{end}}

                            <!-- Status Badge -->
                            {{if eq .Status "confirmed"}}
                              {{template "badge" (dict "Content" .Status "Color" "green" "Size" "xs")}}
                            {{else if eq .Status "dismissed"}}
                              {{template "badge" (dict "Content" .Status "Color" "zinc" "Size" "xs")}}
                            {{else}}
                              {{template "badge" (dict "Content" .Status "Color" "blue" "Size" "xs")}}
                            {{end}}
                          </div>

                          <!-- Confidence Score -->
                          <span class="text-xs text-zinc-500 dark:text-zinc-400">
                            {{printf "%.0f%%" (mul .ConfidenceScore 100)}} confidence
                          </span>
                        </div>

                        <!-- Description -->
                        <p class="text-sm/5 text-zinc-700 dark:text-zinc-300">
                          {{.Description}}
                        </p>

                        <!-- Location -->
                        {{if .Location.Valid}}
                          <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">
                            üìç Location: {{.Location.String}}
                          </p>
                        {{end}}
                      </div>
                    {{end}}
                  </div>
                </div>
              {{end}}

              <!-- Context Input (Collapsible) -->
              <div x-data="{ showContext: false }" class="mt-3">
                <button
                  @click="showContext = !showContext"
                  type="button"
                  class="flex w-full items-center justify-between rounded-lg border border-zinc-950/10 bg-white px-3 py-2 text-xs font-medium text-zinc-700 hover:bg-zinc-50 dark:border-white/10 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">
                  <span>Add Context (optional)</span>
                  <svg x-show="!showContext" class="size-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                  <svg x-show="showContext" x-cloak class="size-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                  </svg>
                </button>
                <div x-show="showContext" x-collapse x-cloak class="mt-2">
                  {{template "textarea" (dict
                    "Name" "context"
                    "ID" (printf "context-%s" (.ID.String))
                    "Rows" 3
                    "Placeholder" "e.g., Check for missing PPE on workers near heavy equipment..."
                    "Class" "text-xs"
                  )}}
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="mt-3 flex gap-2">
                <button
                  hx-post="/api/photos/analyze"
                  hx-include="#context-{{.ID.String}}"
                  hx-vals='{"photo_id": "{{.ID.String}}"}'
                  hx-target="closest .rounded-xl"
                  hx-swap="outerHTML"
                  class="flex-1 rounded-lg bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-500 dark:bg-blue-500 dark:hover:bg-blue-400">
                  Analyze
                </button>
                <button
                  hx-delete="/api/photos/{{.ID.String}}"
                  hx-confirm="Are you sure you want to delete this photo?"
                  hx-target="closest .rounded-xl"
                  hx-swap="outerHTML swap:1s"
                  class="rounded-lg border border-zinc-950/10 bg-white px-3 py-2 text-xs font-semibold text-zinc-700 hover:bg-zinc-50 dark:border-white/10 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700">
                  Delete
                </button>
              </div>
            </div>
          {{else}}
            <div class="col-span-full text-center py-12">
              <p class="text-sm text-zinc-500 dark:text-zinc-400">No photos uploaded yet.</p>
            </div>
          {{end}}
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-4 flex-wrap">
        <a href="/projects/{{.Inspection.ProjectID}}/inspections">
          {{template "button" (dict "Content" "Back to Inspections" "Variant" "outline")}}
        </a>
        <a href="/projects/{{.Inspection.ProjectID}}">
          {{template "button" (dict "Content" "View Project" "Variant" "outline")}}
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Show upload status when form is submitted
  document.getElementById('upload-form').addEventListener('htmx:beforeRequest', function() {
    document.getElementById('upload-status').style.display = 'block';
  });

  // Hide upload status and reset form when complete
  document.getElementById('upload-form').addEventListener('htmx:afterRequest', function(event) {
    document.getElementById('upload-status').style.display = 'none';
    if (event.detail.successful) {
      document.getElementById('photo-upload').value = '';
    }
  });
</script>
{{end}}
