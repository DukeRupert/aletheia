{{template "base" .}}

{{define "title"}}Inspection #{{.Inspection.ID}} - Aletheia{{end}}

{{define "content"}}
<div class="container">
  <div class="stack" style="margin-top: var(--space-xl);">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: start;">
      <div>
        <h1>Inspection #{{.Inspection.ID}}</h1>
        <p style="color: #666; margin-top: var(--space-xs);">
          <strong>Project:</strong> {{.ProjectName}}
          {{if .ProjectLocation}} | <strong>Location:</strong> {{.ProjectLocation}}{{end}}
        </p>
      </div>
      <span style="padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;
        {{if eq .Inspection.Status "draft"}}background: #f3f4f6; color: #374151;
        {{else if eq .Inspection.Status "in_progress"}}background: #dbeafe; color: #1e40af;
        {{else if eq .Inspection.Status "completed"}}background: #d1fae5; color: #065f46;
        {{else}}background: #fef3c7; color: #92400e;{{end}}">
        {{.Inspection.Status}}
      </span>
    </div>

    <!-- Inspection Details Card -->
    <div class="card">
      <h2>Inspection Details</h2>
      <div style="display: grid; gap: var(--space-md); margin-top: var(--space-md);">
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Inspector ID:</strong></p>
          <p>{{.Inspection.InspectorID}}</p>
        </div>
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Created:</strong></p>
          <p>{{.Inspection.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</p>
        </div>
        <div>
          <p style="color: #666; font-size: 0.875rem; margin-bottom: var(--space-xs);"><strong>Last Updated:</strong></p>
          <p>{{.Inspection.UpdatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}</p>
        </div>
      </div>
    </div>

    <!-- Photo Upload Section -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
        <h2 style="margin: 0;">Photos</h2>
        <span style="color: #666; font-size: 0.875rem;">{{len .Photos}} photo(s)</span>
      </div>

      <!-- Upload Form -->
      <form
        hx-post="/api/upload"
        hx-encoding="multipart/form-data"
        hx-target="#photo-list"
        hx-swap="afterbegin"
        id="upload-form"
        style="margin-bottom: var(--space-lg);">

        <input type="hidden" name="inspection_id" value="{{.Inspection.ID}}">

        <div style="padding: var(--space-md); background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 4px;">
          <label for="photo-upload" style="display: block; cursor: pointer;">
            <div style="text-align: center;">
              <svg style="width: 48px; height: 48px; margin: 0 auto var(--space-sm); color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p style="font-weight: 600; margin-bottom: var(--space-xs);">Click to select a photo</p>
              <p style="color: #666; font-size: 0.875rem;">JPEG, PNG, or WebP (max 5MB)</p>
            </div>
          </label>
          <input
            type="file"
            id="photo-upload"
            name="image"
            accept="image/jpeg,image/png,image/webp"
            style="display: none;"
            onchange="document.getElementById('upload-form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }))">
        </div>

        <div id="upload-status" style="margin-top: var(--space-sm); display: none;">
          <div style="padding: var(--space-sm); background: #dbeafe; border-radius: 4px; color: #1e40af; font-size: 0.875rem;">
            Uploading photo...
          </div>
        </div>
      </form>

      <!-- Photo Grid -->
      <div id="photo-list" class="grid">
        {{range .Photos}}
          <div class="card" style="padding: var(--space-sm);">
            <a href="{{.StorageUrl}}" target="_blank">
              <img
                src="{{if .ThumbnailUrl.Valid}}{{.ThumbnailUrl.String}}{{else}}{{.StorageUrl}}{{end}}"
                alt="Inspection photo"
                style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: var(--space-sm);">
            </a>
            <div style="margin-bottom: var(--space-sm);">
              <p style="color: #666; font-size: 0.75rem; margin: 0;">
                {{.CreatedAt.Time.Format "Jan 2, 3:04 PM"}}
              </p>
            </div>

            {{$violations := index $.ViolationsByPhoto (.ID.String)}}
            {{if $violations}}
              <!-- Violations detected -->
              <div style="margin-bottom: var(--space-sm); padding: var(--space-sm); background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 4px;">
                <p style="font-weight: 600; font-size: 0.875rem; color: #dc2626; margin-bottom: var(--space-xs);">
                  {{len $violations}} Violation(s) Detected
                </p>
                {{range $violations}}
                  <div style="margin-bottom: var(--space-xs); padding: var(--space-xs); background: white; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-2xs);">
                      <span style="padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;
                        {{if eq .Severity "critical"}}background: #dc2626; color: white;
                        {{else if eq .Severity "high"}}background: #f97316; color: white;
                        {{else if eq .Severity "medium"}}background: #fbbf24; color: #78350f;
                        {{else}}background: #94a3b8; color: white;{{end}}">
                        {{.Severity}}
                      </span>
                      <span style="font-size: 0.7rem; color: #64748b;">
                        {{printf "%.0f%%" (mul .ConfidenceScore 100)}} confidence
                      </span>
                    </div>
                    <p style="font-size: 0.8rem; color: #334155; margin: 0;">
                      {{.Description}}
                    </p>
                    {{if .Location.Valid}}
                      <p style="font-size: 0.7rem; color: #64748b; margin-top: var(--space-2xs); margin-bottom: 0;">
                        Location: {{.Location.String}}
                      </p>
                    {{end}}
                  </div>
                {{end}}
              </div>
            {{end}}

            <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap;">
              <button
                hx-post="/api/photos/analyze"
                hx-vals='{"photo_id": "{{.ID}}"}'
                hx-target="closest .card"
                hx-swap="outerHTML"
                class="btn-primary"
                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; flex: 1;">
                Analyze
              </button>
              <button
                hx-delete="/api/photos/{{.ID}}"
                hx-confirm="Are you sure you want to delete this photo?"
                hx-target="closest .card"
                hx-swap="outerHTML swap:1s"
                class="btn-secondary"
                style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                Delete
              </button>
            </div>
          </div>
        {{else}}
          <div style="text-align: center; padding: var(--space-2xl); color: #666; grid-column: 1 / -1;">
            <p>No photos uploaded yet.</p>
          </div>
        {{end}}
      </div>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
      <a href="/projects/{{.Inspection.ProjectID}}/inspections" class="btn-secondary">Back to Inspections</a>
      <a href="/projects/{{.Inspection.ProjectID}}" class="btn-secondary">View Project</a>
    </div>
  </div>
</div>

<script>
  // Show upload status when form is submitted
  document.getElementById('upload-form').addEventListener('htmx:beforeRequest', function() {
    document.getElementById('upload-status').style.display = 'block';
  });

  // Hide upload status and reset form when complete
  document.getElementById('upload-form').addEventListener('htmx:afterRequest', function(event) {
    document.getElementById('upload-status').style.display = 'none';
    if (event.detail.successful) {
      document.getElementById('photo-upload').value = '';
    }
  });
</script>
{{end}}
